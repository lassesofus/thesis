# Coordinate System Changes - DROID Standard

## Summary

Both `generate_droid_sim_data.py` and `robo_samples.py` now consistently follow the **DROID coordinate frame convention** for all user-facing flags and outputs.

## Coordinate Frame Relationship

```
DROID_x = RoboHive_y
DROID_y = RoboHive_x
DROID_z = RoboHive_z
```

## Changes Made to `robo_samples.py`

### 1. Added Helper Function

Added `robohive_to_droid_pos()` function (line 75) to convert positions from RoboHive frame to DROID frame for display purposes.

```python
def robohive_to_droid_pos(pos_robohive):
    """Convert RoboHive position to DROID frame for display."""
    return np.array([pos_robohive[1], pos_robohive[0], pos_robohive[2]])
```

### 2. Remapped Experiment Type Flags

**Before:** `--experiment_type x/y/z` specified movement in RoboHive coordinate frame
**After:** `--experiment_type x/y/z` specifies movement in DROID coordinate frame

| Flag | Movement Direction (DROID Frame) | Internal RoboHive Offset |
|------|----------------------------------|--------------------------|
| `--experiment_type x` | DROID X-axis (+0.2m) | RoboHive [0.0, 0.2, 0.0] |
| `--experiment_type y` | DROID Y-axis (+0.2m) | RoboHive [0.2, 0.0, 0.0] |
| `--experiment_type z` | DROID Z-axis (+0.2m) | RoboHive [0.0, 0.0, 0.2] |

### 3. Enhanced Debug Output

All position prints now show both coordinate frames:

```
End effector starting position (RoboHive): [0.500 0.000 0.400]
End effector starting position (DROID): [0.000 0.500 0.400]

Target position (RoboHive x,y,z) = (0.500,0.200,0.400)
Target position (DROID x,y,z) = (0.200,0.500,0.400)
```

### 4. Clarified Action Transformations

Updated comments in `transform_action()` to clarify it transforms from **DROID → RoboHive**:

```python
# V-JEPA outputs actions in DROID frame
Raw planned action (DROID frame x,y,z): (0.050, 0.020, 0.010)

# After transformation for RoboHive execution
Transformed action (RoboHive frame x,y,z): (0.020, 0.050, 0.010)
```

## How It Works

### Training Data Generation (`generate_droid_sim_data.py`)

1. **Internal simulation:** Runs in RoboHive coordinate frame
2. **Pose transformation:** All saved poses/actions converted to DROID frame via `transform_pose_to_droid_frame()`
3. **Saved data:** Stored in DROID coordinate frame in HDF5 files
4. **V-JEPA training:** Model learns from DROID-frame data

### Deployment (`robo_samples.py`)

1. **User specifies:** `--experiment_type x` (meaning DROID x-axis)
2. **Internal conversion:** Script converts to RoboHive coordinates [0.0, 0.2, 0.0]
3. **Execution:** Robot moves in RoboHive frame
4. **V-JEPA planning:** Model outputs actions in DROID frame
5. **Action transformation:** `transform_action()` converts DROID → RoboHive
6. **Debug output:** Shows both frames for verification

## Example Usage

### Generate Training Data (X-axis movement in DROID frame)

```bash
python generate_droid_sim_data.py \
  --out_dir /data/sim_droid_x \
  --num_trajectories 100 \
  --traj_dir x \
  --min_reach_distance 0.05 \
  --max_reach_distance 0.3
```

This generates data with movement along DROID x-axis, automatically saved in DROID coordinates.

### Run Evaluation (X-axis movement in DROID frame)

```bash
python robo_samples.py \
  --render offscreen \
  --experiment_type x \
  --enable_vjepa_planning \
  --action_transform swap_xy \
  --planning_steps 10
```

This tests reaching along DROID x-axis, with V-JEPA actions automatically transformed from DROID to RoboHive.

## Verification

To verify coordinate consistency, check the debug output:

```
Experiment type: X-axis (DROID frame)
  RoboHive offset: [0.  0.2 0. ]
  DROID offset: [0.2 0.  0. ]

Target delta (RoboHive x,y,z) = (0.000,0.200,0.000)
Target delta (DROID x,y,z) = (0.200,0.000,0.000)
```

The DROID offset should show 0.2m along the x-axis when using `--experiment_type x`.

## Action Transform Flag

**Always use `--action_transform swap_xy`** when running `robo_samples.py` with V-JEPA planning:

- V-JEPA was trained on DROID-frame data (generated by `generate_droid_sim_data.py`)
- V-JEPA outputs actions in DROID frame
- `swap_xy` converts DROID actions → RoboHive actions for execution
- Note: This is the same transformation used in both directions (it's its own inverse)

## Files Modified

1. **`robo_samples.py`**:
   - Added `robohive_to_droid_pos()` helper function
   - Remapped `--experiment_type` flags to DROID conventions
   - Enhanced debug output to show both coordinate frames
   - Clarified action transformation comments

2. **`generate_droid_sim_data.py`**:
   - Fixed documentation to match implementation
   - Clarified that transformation is `swap_xy` (not `swap_xy_negate_x`)
   - Updated all docstrings and comments for consistency

## Benefits

1. **Consistency:** All user-facing flags now use DROID conventions
2. **Transparency:** Debug output shows both frames for verification
3. **Simplicity:** User doesn't need to mentally convert between coordinate systems
4. **Correctness:** Automatic transformations ensure proper execution
